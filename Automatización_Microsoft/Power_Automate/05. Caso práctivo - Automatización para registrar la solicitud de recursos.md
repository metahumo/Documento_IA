
---

# Automatización para registrar la solicitud de talleres — Documentación técnica

## Introducción

Esta herramienta es un flujo determinista en Power Automate que monitoriza el correo entrante, detecta solicitudes de talleres por coincidencia de remitente o palabra clave definida en SharePoint y, cuando procede, mueve el correo a la carpeta "Talleres" en Outlook y registra la operación en SharePoint.

No emplea modelos de IA: se basa en reglas explícitas y listas controladas para maximizar explicabilidad, trazabilidad y control por parte del usuario.

---

## Contexto y objetivo del flujo

Se ha desarrollado una automatización que:

- Supervisa la bandeja de entrada (Inbox).
- Normaliza el remitente a minúsculas y contrasta con una lista de entidades activas de SharePoint (`EntidadesTalleres`).
- Detecta también por palabra clave (definida por entidad), buscando en el asunto y en el cuerpo del correo.
- Si hay coincidencia (por correo o palabra clave), mueve el correo a la carpeta **Talleres** y registra el evento en la lista `SolicitudesTalleres`.
- Si el remitente no existe aún en `EntidadesTalleres`, crea un registro nuevo con `ACTIVO = false` (OFF) y `PALABRACLAVE = "taller"` para que el usuario/a lo habilite manualmente.
- Si no hay coincidencias, el flujo no realiza ninguna acción.

El diseño prioriza la intervención humana donde corresponde (habilitar entidades nuevas) y un comportamiento claro y auditable.

---

## Configuración previa

Antes de activar el flujo, prepara estas dependencias. *Los nombres de las carpetas deben de ser exactamente estos para no modificar los parámetros del flujo*

### A) Listas en SharePoint (sitio de trabajo)

- **Sitio**: [REDACTADO] (ejemplo orientativo: `https://<tu_org>.sharepoint.com/sites/<tu_sitio>`)

1) **EntidadesTalleres** (lista de referencia)
- Columnas sugeridas:
  - **Title** (Texto) — nombre de la entidad
  - **EMAIL** (Texto) — correo del remitente
  - **LOCALIDAD** (Texto) — municipio de la entidad
  - **PALABRACLAVE** (Texto) — palabra clave asociada (p. ej. "taller, campaña. Se recomienda no usar palabras muy usadas en otros contextos")
  -  **PERSONA DE REFERENCIA** (Texto) — nombre de la persona que contacta
  - **CARPETADESTINO** (Elección/Texto) — valor "Talleres"
  - **ACTIVO** (Sí/No) — controla si la entidad está operativa (1 = activo)

2) **SolicitudesTalleres** (lista de registro)
- Columnas sugeridas:
  - **Title** (Texto) — remitente del correo
  - **FECHARECEPCIÓN** (Fecha y hora)
  - **ASUNTO** (Texto)
  - **ENTIDADDETECTADA** (Texto)
  - **MÉTODODETECCIÓN** (Elección) — valores: "Correo" | "Palabra clave"
  - **MESSAGEID** (Texto)
  - **PROCESADO** (Sí/No)

### B) Carpeta en Outlook

- Crear (si no existe) la carpeta **Talleres** en Outlook.

### C) Conexiones y permisos

- Conectores: **Office 365 Outlook** y **SharePoint Online** con permisos de lectura/escritura en el sitio y listas indicadas.
- El flujo utiliza el disparador "Cuando llega un nuevo correo electrónico (V3)" en `Inbox`.

---

## Resumen técnico del flujo

**Trigger**: Cuando llega un nuevo correo electrónico (V3) — carpeta: `Inbox`.
- Incluir adjuntos: Sí
- Importancia: Cualquiera
- Solo con adjuntos: No
- **Split On**: activado (`@triggerOutputs()?['body/value']`)

**Variables iniciales**:
- `varEntidadDetectada` (string)
- `varMetodoDeteccion` (string)
- `varCarpetaDestino` (string)
- `varDetectado` (boolean) = `false`
- `varEmailRemitente` (string) = `toLower(coalesce(triggerOutputs()?['body/fromAddress'], triggerOutputs()?['body/from']))`

**Pasos principales**:

1. Consultar `EntidadesTalleres` activas (`ACTIVO eq 1`).
2. Iterar entidades activas y evaluar detección única:
   - Coincidencia por **correo**: si `varEmailRemitente == toLower(item.EMAIL)`, marca detección y registra la carpeta destino y método "Correo".
   - Si no coincide el correo, probar **palabra clave**: `contains(toLower(subject), toLower(item.PALABRACLAVE))` OR `contains(toLower(body), toLower(item.PALABRACLAVE))`. Si detecta, marca método "Palabra clave" y carpeta destino.
   - La evaluación se detiene al primer acierto (`varDetectado` pasa a `true`).
3. Si hay detección:
   - Mover el correo a carpeta **Talleres**.
   - Crear elemento en `SolicitudesTalleres` con detalles (remitente, fecha, asunto, entidad detectada, método, id de mensaje, procesado = true).
4. Comprobar si el remitente existe ya en `EntidadesTalleres`:
   - Si **no existe**, crear un nuevo registro con:
     - `EMAIL = remitente del correo`
     - `PALABRACLAVE = "taller"`
     - `CARPETADESTINO = "Talleres"`
     - `ACTIVO = false` (OFF)
5. Finalizar el flujo.

**Comportamiento**:
- Con coincidencia (correo o clave) → mover a "Talleres" + registrar en `SolicitudesTalleres` + alta (si procede) en `EntidadesTalleres` con ACTIVO en OFF por defecto.
- Sin coincidencia → no acción.

---

## Mapeo de acciones (detallado)

A continuación se describen las acciones y configuraciones clave del flujo (nombres según definición).

### TRIGGER: Cuando llega un nuevo correo electrónico (V3)

**Acción:** Office 365 Outlook → Cuando llega un nuevo correo electrónico (V3)

**Configuración:**
- **Carpeta:** `Inbox`
- **Incluir datos adjuntos:** `true`
- **Importancia:** `Any`
- **Solo con datos adjuntos:** `false`
- **Split On/Dividir:** `@triggerOutputs()?['body/value']` ✅ ACTIVADO

---

### Variables iniciales

- **Entidad_detectada** — InitializeVariable
  - `varEntidadDetectada` (string)
- **Metodo_deteccion** — InitializeVariable
  - `varMetodoDeteccion` (string)
- **Carpeta_destino** — InitializeVariable
  - `varCarpetaDestino` (string)
- **Detectado** — InitializeVariable
  - `varDetectado` (boolean) = `false`
- **Email_remitentes** — InitializeVariable
  - `varEmailRemitente` (string)
  - Valor: `@toLower(coalesce(triggerOutputs()?['body/fromAddress'], triggerOutputs()?['body/from']))`

---

### Obtener entidades activas

**Acción:** SharePoint Online → GetItems

**Nombre:** `Obtener_entidades_activas`

**Configuración:**
- **Dataset/Sitio:** [REDACTADO]
- **Tabla (lista):** `EntidadesTalleres` (Id interna: [REDACTADO])
- **Filtro:** `ACTIVO eq 1`
- **Paginación mínima:** 250 elementos

---

### Detección (foreach sobre entidades activas)

**Acción:** `Aplicar_a_cada_uno` — Foreach

- Evaluación encapsulada por `Se_detecta_algo` (If) para ejecutar solo si `varDetectado == false`.

1) **Coincide_email** (If):
- Expresión: `@variables('varEmailRemitente') == @toLower(items('Aplicar_a_cada_uno')?['EMAIL'])`
- SI:
  - `Si_coincide_Entidad_detectada` → `varEntidadDetectada = items('Aplicar_a_cada_uno')?['Title']`
  - `Si_coincide_Carpeta_destino` → `varCarpetaDestino = items('Aplicar_a_cada_uno')?['CARPETADESTINO/Value']`
  - `Si_coincide_Metodo_deteccion` → `varMetodoDeteccion = 'Correo'`
  - `Si_coincide_Detectado` → `varDetectado = true`
- NO: evalúa palabra clave.

2) **Coincide_palabra_clave_asunto_o_cuerpo** (If):
- Expresión:
  - `contains(toLower(subject), toLower(item.PALABRACLAVE))` OR
  - `contains(toLower(body), toLower(item.PALABRACLAVE))`
- SI:
  - `Coincide_Entidad_detectada` → `varEntidadDetectada = ''`
  - `Coincide_Carpeta_destino` → `varCarpetaDestino = items('Aplicar_a_cada_uno')?['CARPETADESTINO/Value']`
  - `Coincide_Metodo_detectado` → `varMetodoDeteccion = 'Palabra clave'`
  - `Coincide_Detectado` → `varDetectado = true`

---

### Condición global (si se detecta algo)

**Acción:** `Condición_global` — If (`varDetectado == true`)

- **Mover_correo_electrónico_(V2)** — Outlook → MoveV2
  - **Id del mensaje:** `@triggerOutputs()?['body/id']`
  - **Carpeta:** `Talleres` (folderId resuelto por metadata)

- **Crear_elemento** — SharePoint → PostItem (lista `SolicitudesTalleres`)
  - **Dataset:** [REDACTADO]
  - **Tabla (lista):** Id interna [REDACTADO]
  - **Campos:**
    - `Title = @triggerOutputs()?['body/from']`
    - `FECHARECEPCIÓN = @triggerOutputs()?['body/receivedDateTime']`
    - `ASUNTO = @triggerOutputs()?['body/subject']`
    - `ENTIDADDETECTADA = @coalesce(variables('varEntidadDetectada'),'')`
    - `MÉTODODETECCIÓN = @variables('varMetodoDeteccion')`
    - `MESSAGEID = @triggerOutputs()?['body/id']`
    - `PROCESADO = true`

---

### Alta de entidad si no existe

- **Email_existe** — InitializeVariable
  - `varEmailExiste` (boolean) = `false`

- **Obtener_elementos** — SharePoint → GetItems (lista `EntidadesTalleres`)
  - **FolderPath:** [REDACTADO] (p. ej. `/Lists/Talleres`)

- **Aplicar_a_cada_uno_1** — Foreach
  - **Pregunta_Coincide_email** (If): `toLower(item()['EMAIL']) == varEmailRemitente`
  - SI: `varEmailExiste = true`

- **Registro_EntidadesTalleres_si_no_existe** — If (`varEmailExiste == false`)
  - **Agregar_registro_EntidadesTalleres** — SharePoint → PostItem
    - `EMAIL = @triggerOutputs()?['body/from']`
    - `PALABRACLAVE = 'taller'`
    - `CARPETADESTINO = 'Talleres'`
    - `ACTIVO = false`

---

### Finalizar

- **Finalizar** — Terminate
  - **Estado:** `Succeeded`

---

## Flujo visual (detallado)

```
┌─────────────────────────────────────────────────────────────────┐
│ TRIGGER: Cuando llega un nuevo correo electrónico (V3)          │
│ Folder: Inbox | Include Attachments: Yes | Split On: Enabled    │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│ Variables: Entidad, Método, Carpeta, Detectado=false,           │
│            EmailRemitente (toLower(coalesce(fromAddress, from)) │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│ Obtener_entidades_activas (ACTIVO eq 1)                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│ Foreach entidades activas (si Detectado == false)               │
│  ├─ Coincide_email → Detectado=true (Método: Correo)            │
│  └─ Else Coincide_palabra_clave → Detectado=true (Método: Clave)│
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│ If Detectado == true                                            │
│  ├─ Mover correo → Carpeta "Talleres"                          │
│  └─ Crear elemento → Lista "SolicitudesTalleres"               │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│ Alta en EntidadesTalleres si remitente no existe                │
│  └─ EMAIL, PALABRACLAVE="taller", CARPETA="Talleres", ACTIVO=OFF│
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│ FINALIZAR (Succeeded)                                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## Notas de control manual

- **Habilitar nuevas entidades**: cuando el flujo crea un registro nuevo en `EntidadesTalleres`, éste queda con `ACTIVO = false` (OFF). El usuario/a debe editar manualmente y poner `ACTIVO = true` (ON) para que futuras solicitudes de ese remitente o su `PALABRACLAVE` sean detectadas.
- **Ajustar la palabra clave**: la columna `PALABRACLAVE` puede refinarse por entidad para mejorar la precisión. Por defecto, el alta inicial se crea con "taller".
- **Carpeta destino**: `CARPETADESTINO` puede mantenerse en "Talleres" o adaptarse según organización, siempre que exista la carpeta en Outlook y el flujo tenga su Id.
- **Trazabilidad**: cada detección correcta registra un elemento en `SolicitudesTalleres` con detalles del correo y el método usado.

---

## Riesgos y limitaciones

- **Falsos positivos**: palabras clave genéricas (p. ej. "taller") pueden generar detecciones no deseadas si aparecen en comunicaciones no relacionadas. El uso de herramientas de automatización requiere de unas pautas de buenas prácticas por parte de la organización y sus miembros para evitar falsos positivos.
- **Contenido HTML**: la detección de palabra clave se realiza sobre el asunto y el cuerpo tal como llega; no se aplica una conversión explícita a texto plano.
- **Adjuntos**: no se analizan adjuntos; sólo asunto/cuerpo.
- **Mantenimiento**: la lista `EntidadesTalleres` requiere curación (activar entidades válidas y ajustar palabras clave).

---

## Conclusión

El flujo proporciona una ruta controlada y auditable para clasificar correos de solicitudes de talleres, delegando en el usuario/a la activación de nuevas entidades y manteniendo un registro en `SolicitudesTalleres`. Es sencillo de mantener, transparente y reduce trabajo manual al mover automáticamente los correos detectados a la carpeta "Talleres". Puede complementarse con Power App, permitiendo agregar nuevas entradas desde el móvil y facilitando su posterior recepción de mails.
